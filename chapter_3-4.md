# 멀티 플레이어 게임 프로그래밍

# 3. 버클리 소켓

## TCP 소켓

- UDP와는 달리 신뢰성을 보장하며, 연결을 맺은 상태를 유지해야 한다. 즉, 호스트가 각 TCP 연결마다 별개의 독자적 소켓을 하나씩 유지해야 한다.

- 클라이언트아 서버 사이에 연결을 초기 수립하려면 3-웨이 핸드셰이킹을 거쳐야 한다.

### listen()


- 소켓 생성과 바인딩 이후에 바로 해당 함수부터 시작된다.

        int listen(SOCKET sock, int backlog);

    - sock
        - 리스닝 모드에 둘 소켓을 가리킨다.
        - 리스닝 모드에 있으면 외부에서 들어오는 TCP 핸드셰이킹 첫 단계 요청을 받아 이를 대기열에 저장해 둔다.
        - 이후 프로세스가 accept()를 호출하면 저장해 둔 연결 요청에 다음 핸드셰이킹 단계로 넘어간다.
    - backlog
        - 대기열에 연결이 들어오는 것을 둘 최대 개수를 지정한다.
        - 대기열이 가득차면 이 후로 들어오려는 연결은 끊어진다.
        - 기본값 메크로는 SOMAXCONN이다.
    - 출력
        - 성공 : 0
        - 실패 : -1
    
### accept()

- listen()함수가 리스닝 모드로 둔 소켓을 기반으로 원격 호스트와 통신이 가능한 새로운 소켓을 만드는 기능을 수행한다.

        SOCKET accept(SOCKET sock, sockaddr* addr, int*addrlen);

    - sock : 리스닝 모드의 소켓으로, 여기서 들어오는 요청을 받게 된다.
    - addr 
        - 해당 함수가 연결을 요청하는 원격 호스트의 주소를 채워줄 sockaddr 구조체 포인터이다.
        - 오로지 수락된 연결의 주소를 받는 용도로만 사용된다.
    - addrlen
        - addr 버퍼의 포인터 길이를 반환하는 용도로 사용된다.
        - addr 내용이 채워질 때만 그 길이가 해당변수 채워진다.
    - 반환
        - 원격 호스트와 통신이 가능한 소켓
            - 해당 소켓은 리스닝 소켓과 같은 포트로 바인딩된다.

### connect()

- accept()가 반환한 소켓을 이용하여 원격 서버에 접속하고, 핸드셰이킹 절차를 시작하게 된다.

        int connetc(SOCKET sock, const sockaddr* addr, int addrlen);

    - sock : 연결에 사용하고자 하는 소켓이다,
    
    - addr : 연결하고자 하는 원격 호스트의 주소를 가리키는 포인터이다.
    - addrlen : addr의 길이이다.
    - 반환값 
        - 성공 : 0
        - 실패 : -1

- 해당 함수를 호출하면 최초 SYN패킷을 대상 호스트에 정송하여 TCP 행드셰이킹을 개시한다.
- 원격 호스트에 해당 포트로 바인딩한 리스닝 모드 소켓이 있을 결우, 서버 원격 호스트는 accept()를 호출하여 이 핸드셰이킹을 처리한다,
- 별다른 옵션이 없다면 해당 함수 호출시 호출 스레드는 연결이 수락되거나 초과할 때까지 블로킹된다.