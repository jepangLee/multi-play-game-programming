# 멀티 플레이어 게임 프로그래밍

## 1. TCP/IP 스택의 계층 구조

- 총 4단계로 구성되어 있다.

    ![TCP/IP 스택](https://thebook.io/img/006821/045_01.jpg)
    그림 1) 게임 개발 관점에서 나눈 TCP/IP 계층 
## 2. 물리 계층(physical layer)

- 계층 가장 아래에 위치하였다.

- 호스트 사이의 물리적 연결을 책임지는 영역이다.

- 이용되는 매체

    - 전화선

    - 동축 케이블

    - 광섬유 케이블

    - TP CAT-6케이블

    - 전파 등

## 3. 링크 계층(link layer)

- 물리적으로 연결된 호스트 사이의 통신 수단을 제공한다.

- 송신 호스트가 정보를 꾸려 물리 계층을 통해 정보를 보낼 수 있는 수단을 제공한다.

- 수신 호스트가 높은 확률로 그 정보를 수신하여 안에 담긴 정보를 꺼낼 수 있게 하는 수단을 제공한다.
    - 특정 목적지에 주소를 부여해서 각 프레임에 기재토록 하여 호스트를 식별할 수단 제공

    - 수신 측 주소와 데이터를 담을 수 있는 프레임 포맷 정의
    - 한 번에 데이터를 얼마까지 보낼 수 있는지 윗단 계층에서 알 수 있게끔 프레임의 최대 길이를 정의
    -  물리 계층을 거쳐 전달된 신호를 의도된 호스트가 수신할 수 있게 프레임을 물리적인 전기 신호로 변환하는 방법을 정의

- 보낸 신호가 훼손되었거나 목적지에 도착하지 못했어도 다시 보내려는 시도 등을 전혀 하지 않는 비신뢰성(Unreliable)통신 계층이다.

- 따라서 보다 상위 프로토콜에서 데이터의 전송을 보장하려면, 즉 신뢰성(Reliable) 통신을 구축하려면 다시 보내는 등의 메커니즘을 직접 구현해야 한다.

  | 물리적 매체 | 링크 계층 프로토콜 |
  |:--------|:--------|
  | TP 케이블(랜선) | 이더넷 10BASE-T, 이더넷 100BASE-T, 이더넷 1000BASE-T |
  | Twisted copper wire | 구리선 이더넷 통신(Ethernet over copper, EoC) |
  | 2.4GHz 전파 | 802.11b, 802.11g, 802.11n |
  | 5GHz 전파 | 802.11n, 802.11ac |
  | 850MHz 전파 | 3G, 4G |
  | 광케이블 | FDDI(fiber distributed data interface, 광섬유 분산 데이터 인터페이스), 이더넷 10G BASE-SR, 이더넷 10G BASE-LR|
  | 동축 케이블(Coaxial cable) | 동축 이더넷 (Ethernet over coax, EoC), DOCSIS(data over cable service interface specification) |

  

   표 1) 물리 매체와 그에 대응하는 링크 계층 프로토콜

  - 링크 계층과 물리계층은 서로 밀접하게 연관되어있다 보니 일부 모형에는 하나의 계층으로 묘사하기도 한다. 
  - 하지만 하나 이상의 링크 계층 프로토콜을 지원하는 물리적 매체도 있으므로 서로 구별하는 편이 좋다.

### 이더넷/802.3

  - 이더넷 표준
      - 1980년도 DEC, Intel, xerox가 공동으로 제창했다.

      - 현재 IEEE 802.3 표준으로 정의하고 있다.
  - 동축 케이블, 광섬유 등 매체에 상응하는 이더넷 파생 프로토콜이 있다.
    
#### MAC(Media Access Control address)
- 여러 호스트를 식별하기 위해 이더넷에서 매체 접근 제어 주소, 줄여서 MAC 주소를사용한다.

- 이론상 고유한 48비트 숫자로서 이더넷 네트워크에 연결 가능한 장비 하나하나마다 고유 값이 부여된다.
- 앞 24비트는 OUI(organizationally unique identifier), 즉 제조업체 식별 코드로 IEEE가 제조사마다 고유한 번호를 할당해 주고, 나머지 24비트는 제조업체에서 할당한다.
- 이더넷 이외에도 WIFI나 Bluetooth 등 대부분 IEEE 802 링크 계층 프로토콜이 MAC 주소를 사용하고 있다.

#### NIC(Network interface controller)
- MAC주소가 부여된 장비를 통칭 네트워크 인터페이스 콘트롤러, 줄여서 NIC라 부른다.

- 해당 장비는 과거 확장카드 현태로 만들어 졌지만 오늘날은 메인보드에 내장하여 출시한다.
- 단, 두가지 이상의 네트워크를 연결해야 하는 등의 경우에는 확장 카드를 장착하면 된다.
    ![TCP/IP 스택](/image/picture_1.PNG)

  그림 2) 이더넷 패킷 구조
- 0 ~ 7byte 
  - NIC가 이진수 패턴을 체크하여 동기화를 맞추고, 새 프레임을 받을 준비를 한다.
  - 프리앰블(preamble) : 0 ~ 6byte
    - 0x55 7개
  - SFD(start frame delimiter) : 7byte
    -  0xD5 1개
- 8byte 이상 :
  - 이더넷 모듈이 처리한다.
      
  - 수신자 MAC주소 : 8 ~ 13byte
    - 브로드캐스트 주소라는 특수 MAC 주소도 있는데 FF:FF:FF:FF:FF:FF를 나타내며 LAN상 연결된 모든 호스트에 전달하고자 할 때 사용된다.
  
  - 발신자 MAC주소 : 14 ~ 19byte
  - 길이/종류 필드 : 20 ~ 21byte
    - 오버로드하여 길이나 종류 둘 중 하나로 사용한다. 
  - 길이 (값 : 0 ~ 1500)
    - 프레임에 포함된 페이로드의 길이를 바이트 단위로 나타냄 

    - MTU(Maximum transmission unit)
      - 최대 전송 유닛은 이더넷 모듈이 해당 필드를 처리할 때 정확하게 해석할 수     있도록 이더넷 표준은 페이로드 길이를 최대 1500byte로 정해둠
    - 종류 (값 : 1536 ~ )
      - 이더타입(Ether Type) 고유 식별자 값을 기록해 페이로드 내 데이터를 어떻게 해석해야 하는지 표시함
      
      - 최솟값이 0x600, 즉 1536이다.
      - 
  - 페이로드
    -  프레임에 담겨 전송되는 데이트 그 자체를 뜻함

    -  대게 호스트로 전달하고픈 네티워크 계층 패킷이 담겨있다.
  - 프레임 체크 시퀸스(frame check sequence, FCS)
    - CRC32 값으로 이는 여러 값을 걸쳐 연산하여 얻은 체크섬 값이다. 
    - 사용 값은 발신자와 수신자의 주소 각각, 길이/종류 필드, 페이로드 그리고 패딩값 등이다.
    - 하드웨어가 이를 체크하고, 손상된 경우 프레임을 폐기한다.
